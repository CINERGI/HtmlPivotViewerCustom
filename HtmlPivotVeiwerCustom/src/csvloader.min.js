PivotViewer.Models.Loaders.CSVLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(n,t){this.csvUriNoProxy=n;this.csvUri=t?t+n:n},loadCollection:function(n){var i,r,t;this.collection=n;this.collection.config={};this._super(n);n.baseNoProxy=this.csvUriNoProxy;n.base=this.csvUri;i=n.base;r=i.substring(i.lastIndexOf("/")+1,i.lastIndexOf("."));n.name=r;n.imageBase=r+"/"+r+".dzc";n.brandImage="";t=this;this.csvUri.endsWith(".zip")?jBinary.loadData(this.csvUri).then(function(n){var i=new JSZip;i.load(n);t.data=i.file(/.csv/)[0].asText().csvToArray();t.loadData()}):$.ajax({type:"GET",url:this.csvUri,dataType:"text",success:function(n){if(Debug.log("CSV loaded"),t.data=n.csvToArray(),t.data.length<=1){$(".pv-loading").remove();$(".pv-wrapper").append('<div id="pv-empty-collection-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>There are no items in the CSV Collection<br><br><\/p><\/div><\/div>');setTimeout(function(){window.open("#pv-empty-collection-error","_self")},1e3);return}t.loadData()},error:function(n,t,i){$(".pv-loading").remove();var r="Error loading CSV Collection<br><br>";r+="URL        : "+this.url+"<br>";r+="Status : "+n.status+" "+i+"<br>";r+="Details    : "+n.responseText+"<br>";r+="<br>Pivot Viewer cannot continue until this problem is resolved<br>";$(".pv-wrapper").append('<div id="pv-loading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X<\/a><h2>HTML5 PivotViewer<\/h2><p>'+r+"<\/p><\/div><\/div>");setTimeout(function(){window.open("#pv-loading-error","_self")},1e3)}})},loadData:function(){for(var u,i,r,f,s,e,l,t=this.data[0],h=-1,c=-1,o=-1,n=0;n<t.length;n++){if(t[n].charAt(0)=="#"){if(t[n]=="#name")h=n;else if(t[n]=="#img")c=n;else if(t[n]=="#href")o=n;else if(t[n]=="#views")for(u=1,this.collection.config.views=[];this.data[u][n]!=null&&this.data[u][n]!="";)this.collection.config.views.push(this.data[u++][n]);continue}f=!0;(i=t[n].indexOf("#"))!==-1?(t[n].indexOf("#number",i)!==-1?r=PivotViewer.Models.FacetType.Number:t[n].indexOf("#date",i)!==-1?r=PivotViewer.Models.FacetType.DateTime:t[n].indexOf("#ordinal",i)!==-1?r=PivotViewer.Models.FacetType.Ordinal:t[n].indexOf("#long",i)!==-1?r=PivotViewer.Models.FacetType.LongString:t[n].indexOf("#link",i)!==-1?(r=PivotViewer.Models.FacetType.Link,f=!1):r=PivotViewer.Models.FacetType.String,t[n].indexOf("#hidden")!==-1&&(f=!1)):(r=PivotViewer.Models.FacetType.String,i=t[n].length);s=new PivotViewer.Models.Category(t[n].substring(0,i),r,f);s.column=n;this.collection.categories.push(s)}for(n=1;n<this.data.length;n++)e=this.data[n],l=new PivotViewer.Models.Item(e[c],String(n),o==-1?"":e[o],e[h]),this.collection.items.push(l);$.publish("/PivotViewer/Models/Collection/Loaded",null)},loadColumn:function(n){for(var e,t,i,r,f=!0,u=0;u<this.collection.items.length;u++)(e=this.collection.items[u],t=this.data[u+1][n.column],t.trim()!="")&&(i=new PivotViewer.Models.Facet(n.name),n.isNumber()||n.isOrdinal()?(r=parseFloat(t.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),i.addValue(new PivotViewer.Models.FacetValue(r,t)),r!=Math.floor(r)&&(f=!1),n.isOrdinal()&&(n.labels[r]=t)):n.isDateTime()?i.addValue(new PivotViewer.Models.FacetValue(moment(t,moment.parseFormat(t))._d.toString(),t)):i.addValue(new PivotViewer.Models.FacetValue(t)),e.facets.push(i));(n.isNumber()||n.isOrdinal())&&(n.integer=f)},getRow:function(n){for(var r,f,o=this.data[n],e=[],u=0;u<Settings.visibleCategories.length;u++){var s=Settings.visibleCategories[u],i=this.collection.categories[s],t=o[i.column];t.trim()!=""&&(r=new PivotViewer.Models.Facet(i.name),i.isNumber()||i.isOrdinal()?r.addValue(new PivotViewer.Models.FacetValue(parseFloat(t.replace(/,/g,"").match(/(?:-?\d+\.?\d*)|(?:-?\d*\.?\d+)/)[0]),t)):i.isDateTime()?r.addValue(new PivotViewer.Models.FacetValue(moment(t,moment.parseFormat(t))._d.toString(),t)):i.isLink()?(f=new PivotViewer.Models.FacetValue(t),f.value=t,f.href=t):r.addValue(new PivotViewer.Models.FacetValue(t)),e.push(r))}return e}});